<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
<title>设置新手机号码</title>
<script src="__STATIC__/js/mui.min.js"></script>
<link href="__STATIC__/css/mui.min.css" rel="stylesheet" />
<link href="__STATIC__/css/css.css" rel="stylesheet" />
<script src="__STATIC__/js/jquery.min.js"></script>
<style>
/*    .note input {
        border: 1px solid #B02F4B;
        border-radius: 4px;
        color: #B02F4B;
        font-size: 14px;
        width: 100px;
        display: block;
        line-height: 40px;
        position: absolute;
        z-index: 33;
        padding-top: 0px;
        padding-right: 5px;
        height: 40px;
        top: 0px;
        right: 5px;
        text-align: center;
        margin-top: 5px;
    }*/
</style>
</head>
<body>
<div class="mui-content">
			<form id='login-form' class="mui-input-group" method="post" action="{: U('Moblie/User/edit_mobile')}">
				<div class="mui-input-row login_text">
				  <input type="text" class="login_text" placeholder="新手机号" name="mobile" id="new_mobile">
				</div>
			  <div class="mui-input-row login_text">
                <div class="note"><a href="javascript:a_code();" id="">获取验证码</a></div>
				  <input type="button" class="mui-input login_text" placeholder="验证码" id="new_code" intervaltime="{: $time}" onClick="sendCode(this,'new_mobile')" >
				</div>
			
		  	<div class="login_btn"><a href="javascript:submit_form();" >确认提交</a></div>
		  </form>
          <div class="login_btn1"><a href="my.html">返回</a></div>


		</div>
<div class="tip-a">修改成功后，请使用新的手机号码登录龙米应用，如登录pc网站，wap网站等</div>
</body>
</html>

<script>
	function submit_form(){
		var new_mobile = $('#mobile').val();
		if(!checkMobile(new_mobile)){
			alert('手机格式错误');
			return false;
		} 
		if($.trim($('#new_code').val()) == '')  
		{
		alert('验证码不能为空');
		return false;     
		}
		$('#login-form').submit();
	}

	function a_code(){
		$('#new_code').trigger('click');
	}

	function sendCode(obj,input_id){
        var id = $(obj).attr('id');
        var input = $('#new_mobile').val();
        var inputs = $('#mobile').val();
        if(!checkMobile(input)){
            alert('手机号码格式错误');//alert('手机号码格式错误');
            return false;
        }
        if(input != inputs){ //手机有修改
          check_phone(input);
        }
        //发送验证码
        $.ajax({
            type : "get",
            url  : "/index.php?m=Index&c=User&a=send_sms_reg_code&send="+input,
            dataType : 'json',
            error: function(request) {
                console.log(request);
                alert('服务器繁忙, 请联系管理员!');//alert("服务器繁忙, 请联系管理员!");
                return;
            },
            success: function(res) {
              console.log(res);
                if(res.status == 1){
                    jsInnerTimeout(id);
                }else{
                    alert('发送失败');//alert('发送失败');
                }
            }
        });
    }

    //验证手机是否已绑定
	function check_phone(input){
	  $.ajax({
	    type:'post',
	    url :"/index.php?m=Index&c=User&a=check_phones&phone="+input,
	    dataType : 'json',
	    error: function(request) {
	        console.log(request);
	        alert('服务器繁忙, 请联系管理员!');//alert("服务器繁忙, 请联系管理员!");
	        return;
	    },
	    success:function(res){
	      if(res == 1){
	        return true;
	      }else if(res == 2){
	        alert('此号码已绑定！');
	        return false;
	      }
	    }
	  });
	}


	//倒计时函数
    function jsInnerTimeout(id)
    {
        var codeObj=$("#"+id);
        var intAs=parseInt(codeObj.attr("IntervalTime"));

        intAs--;
        codeObj.attr("disabled","disabled");
        if(intAs<=-1)
        {
            codeObj.removeAttr("disabled");
            codeObj.attr("IntervalTime","{: $time}");
            codeObj.val("获取验证码");
            return true;
        }

        codeObj.val(intAs+'s后再次获取');
        codeObj.attr("IntervalTime",intAs);

        setTimeout("jsInnerTimeout('"+id+"')",1000);
    };

    /**
     * 手机号码格式判断
     * @param tel
     * @returns {boolean}
     */
    function checkMobile(tel) {
        var reg = /(^1[3|4|5|7|8][0-9]{9}$)/;
        if (reg.test(tel)) {
            return true;
        }else{
            return false;
        };
    }
</script>