<include file="Public/header"/>

<body>
<div class="top_nav">
    <div class="top_nav_left">
        <a href="{:U('Mobile/Goods/goodsList')}">全部</a>
        <a href="{:U('Mobile/Goods/goodsList')}">新品</a>
        <a href="{:U('Mobile/Index/recommendPolite')}">送礼指南</a>
        <a href="{:U('Mobile/Goods/goodsList',array('sort'=>'sales_sum'))}">销量</a>
    </div>
    <form name="sourch_form" id="sourch_form" method="post" action="{:U('Mobile/Goods/goodsList')}">
        <div class="top_nav_right">
            <div class="top_nav_find">
                <input name="find" id="q"  type="text" value="<?php echo I('q'); ?>" placeholder="龙米" />
                <a href="javascript:if($.trim($('#q').val()) != '') $('#sourch_form').submit();" >
                    <img src="__STATIC__/SVG/search_r.svg">
                </a>
            </div>
        </div>
    </form>
</div>



<div id="slider" class="mui-slider" >
    <php>$adv_array =array();</php>
    <adv pid ="2" limit="5" item="v">
        <php>$adv_array[] = $v;</php>
    </adv>
    <php>$adv_array_count = count($adv_array) - 1;</php>
    <notempty name = "adv_array">
        <div class="mui-slider-group mui-slider-loop">
            <!-- 额外增加的一个节点(循环轮播：第一个节点是最后一张轮播) -->
            <div class="mui-slider-item  mui-slider-item-duplicate">
                <a href="{$adv_array[$adv_array_count]['ad_link']}" <if condition="$adv_array[$adv_array_count]['target'] eq 1">target="_blank"</if>>
                <img src="{$adv_array[$adv_array_count]['ad_code']}" title="{$adv_array[$adv_array_count]['title']}"width="100%" style="{$adv_array[$adv_array_count]['style']}">
                </a>
            </div>
            <foreach name="adv_array" item="v" >
                <div class="mui-slider-item">
                    <a href="{$v.ad_link}" <if condition="$v['target'] eq 1">target="_blank"</if>>
                    <img src="{$v[ad_code]}" title="{$v[title]}"width="100%" style="{$v[style]}">
                    </a>
                </div>
            </foreach>
            <!-- 额外增加的一个节点(循环轮播：最后一个节点是第一张轮播) -->
            <div class="mui-slider-item  mui-slider-item-duplicate">
                <a href="{$adv_array[0]['ad_link']}" <if condition="$adv_array[0]['target'] eq 1">target="_blank"</if>>
                <img src="{$adv_array[0]['ad_code']}" title="{$adv_array[0]['title']}" width="100%" style="{$adv_array[0]['style']}">
                </a>
            </div>
        </div>
        <div class="mui-slider-indicator">
            <php>$adv_array_key = 0;</php>
            <foreach name="adv_array" item="v" >
                <!--<div class="mui-indicator <if condition='$adv_array_key++ eq 0'> mui-active</if>"></div>-->
            </foreach>
        </div>
    </notempty>
</div>



<div class="top_menu">
    <ul>
        <li style="background-image:url('__STATIC__/images/new/top_menu_1.png')">
            <p>
                <a href="{:U('Mobile/User/account')}"><b>钱包<br/><span>{:$user['user_money']?$user['user_money']:0}</span></b></a>
            </p>
        </li>
        <li style="background-image:url('__STATIC__/images/new/top_menu_2.png')">
            <p>
                <a href="{:U('Mobile/User/coupon')}"><b>优惠券<br/><span>{$couponCount}</span></b></a>
            </p>
        </li>
        <li style="background-image:url('__STATIC__/images/new/top_menu_3.png')">
            <p>
                <a href="{:U('Mobile/Recommend/index')}"><b>推荐有奖</b></a>
            </p>
        </li>
        <li style="background-image:url('__STATIC__/images/new/top_menu_4.png')">
            <p>
                <a href="{:U('Mobile/User/myPoster')}"><b>赚米<br/><span>{$inviteNumber}</span></b></a>
            </p>
        </li>
    </ul>
</div>


<div class="index_title">
    <img src="__STATIC__/images/new/suixinda3.png">
</div>

<div class="mui-content">
    <ul class="mui-table-view">
        <foreach name="newGoods" item="newGoodsItem" key="newGoodsKey">
            <li class="my_index_cp_li">
                <div class="mui-slider-handle">
                    <div class="c"><a href="{:U('Mobile/Goods/goodsInfo',array('id'=>$newGoodsItem['goods_id']))}"></a></div>
                    <div class="cp_index">
                        <div class="cp_index_l3">
                            <a href="{:U('Mobile/Goods/goodsInfo',array('id'=>$newGoodsItem['goods_id']))}">
                                <img src="{$newGoodsItem.original_img}" width="92" height="92">
                            </a>
                        </div>
                        <div class="cp_index_r">
                            <p class="cj1">{:$newGoodsItem['goods_subtitle']?$newGoodsItem['goods_subtitle']:$newGoodsItem['goods_name']}</p>
                            <p class="cj1">
                                <span>{:$newGoodsItem['goods_label']?$newGoodsItem['goods_label']:$newGoodsItem['goods_name']}</span>
                            </p>
                            <p class="my_index_cp_li_p1">{$newGoodsItem.goods_name}</p>
                            <p class="my_index_cp_li_p1">心动价：￥{$newGoodsItem.shop_price}</p>
                            <p>
                                <a class="cp_index_buy" href="{:U('Mobile/Goods/goodsInfo',array('id'=>$newGoodsItem['goods_id']));}">
                                    立即购买
                                </a>
                            </p>
                        </div>
                    </div>
                </div>
            </li>
        </foreach>
    </ul>
</div>


<div class="index_title">
    <img src="__STATIC__/images/new/suixinda.png">

    <img src="__STATIC__/images/new/suixinda6.jpg">
</div>

<div class="mui-content">
    <ul class="mui-table-view">
        <foreach item="spec" key="key" name="favourite_goods">
            <li class="my_index_spec_li ">
                <div class="mui-slider-handle">
                    <div class="c"><a href="{:U('Mobile/Goods/goodsInfo',array('id'=>$spec['goods_id']))}"></a></div>
                    <div class="cp_index">
                        <div class="cp_index_l">
                            <a href="{:U('Mobile/Goods/goodsInfo',array('id'=>$spec['goods_id']))}">
                                <img src="{$spec['original_img']}" >
                            </a>
                        </div>
                        <div class="cp_index_r">
                            <p class="cj1">带走{$spec.goods_name}</p>
                            <p >
                                <span>{$spec.goods_subtitle}</span>
                            </p>
                            <p class="cj1">心动价：￥{$spec.shop_price}</p>
                            <div class="my-mui-numbox z-index" data-numbox-min='0' data-numbox-max='99'>
                                <button class="mui-btn mui-btn-numbox-minus" onclick="switch_num(-1,'{$spec.goods_id}','0','{$spec.store_count}');" type="button">-</button>
                                <input id="goods_num_{$spec.goods_id}_0" class="mui-input-numbox cp_index_number" type="text" onKeyDown='if(event.keyCode == 13) event.returnValue = false'  value="{:$cart_data[$spec['goods_id'].'_0']['goods_num']?$cart_data[$spec['goods_id'].'_0']['goods_num']:0}"/>
                                <button class="mui-btn mui-btn-numbox-plus"  onclick="switch_num(1,'{$spec.goods_id}','0','{$spec.store_count}');" type="button">+</button>
                            </div>
                        </div>
                    </div>
                </div>
            </li>
        </foreach>
    </ul>
</div>
<include file="Public/nav"/>
</body>


<include file="Public/footer"/>


<script type="text/javascript">

    $(function(){
        TouchSlide({
            slideCell:"#picScroll",
            titCell:".hd ul", //开启自动分页 autoPage:true ，此时设置 titCell 为导航元素包裹层
            autoPage:true, //自动分页
            pnLoop:"false", // 前后按钮不循环
            switchLoad:"_src", //切换加载，真实图片路径为"_src"
            autoPlay:true
        });
        var gallery = mui('.mui-slider');
        gallery.slider({
            interval: 2000//自动轮播周期，若为0则不自动播放，默认为0；
        })
    });

    var before_request = 1; // 上一次请求是否已经有返回来, 有才可以进行下一次请求
    function switch_num(number,goods_id,key,store_count) {
        if (before_request == 0)
        {
            alert("点击太频繁 ,休息一下");
            return false;
        }
        var cart_number = $(".my_cart .figure").html();
        cart_number = parseInt(cart_number);
        console.log(cart_number);
        var num2 = parseInt($("#goods_num_"+goods_id+"_" + key).val());
        if( number < 0 && num2 < 1){
            return false;
        }
        num2 += number;
        if (num2 > store_count) {
            alert("库存只有 " + store_count + " 件, 你只能买 " + store_count + " 件");
            num2 = store_count; // 保证购买数量不能多余库存数量
            $("#goods_num_"+goods_id+"_" + key).val(num2);
            return false;
        }
        before_request = 0;
        $.ajax({
            type : "POST",
            url:"{:U('Mobile/Cart/ajaxChangeCartData')}",
            data : {number:number,goods_id:goods_id,key:key},
            dataType:"json",
            success: function(data){
                alert(data.msg);
                if( data.status==1){
                    $("#goods_num_"+goods_id+"_" + key).val(num2);
                    if( number > 0){
                        flyCart("#goods_num_"+goods_id+"_" + key);
                    }
                    cart_number += number;
                    $(".my_cart .figure").html(cart_number);
                }
                before_request = 1;
            },
            error:function(){
                before_request = 1;
            }
        });
    }

    function flyCart( div_id ) {
        var img = $(div_id).parent().parent().parent().find('img');
        var flyElm = img.clone().css('opacity', 0.75);
        $('body').append(flyElm);
        flyElm.css({
            'z-index': 9000,
            'display': 'block',
            'position': 'absolute',
            'top': $(div_id).offset().top +'px',
            'left': $(div_id).offset().left +'px',
            'width': img.width() +'px',
            'height': img.height() +'px'
        });
        flyElm.animate({
            top: $('.my_cart').offset().top,
            left: $('.my_cart').offset().left + ($('.my_cart').width()/2),
            width: 20,
            height: 32
        }, 'slow', function() {
            flyElm.remove();
        });
    }

</script>
</html>