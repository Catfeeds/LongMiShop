<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <meta name="format-detection" content="telephone=no" />
    <title>{$goods.goods_name}_{$lmshop_config.shop_info_store_title}</title>
    <meta http-equiv="keywords" content="{$lmshop_config['shop_info_store_keyword']}" />
    <meta name="description" content="{$lmshop_config['shop_info_store_desc']}" />
    <script src="__STATIC__/js/mui.min.js"></script>
    <script src="__STATIC__/js/jquery.min.js"></script>
    <script src="__STATIC__/js/function.js"></script>
    <script src="__STATIC__/js/TouchSlide.js"></script>
    <link href="__STATIC__/css/mui.min.css" rel="stylesheet" />
    <link href="__STATIC__/css/css.css?{$versionToken}" rel="stylesheet" />
    <link href="__STATIC__/css/shopping_cart1.css" rel="stylesheet" />
    <script type="text/javascript" src="__STATIC__/js/touchslider.dev.js"></script>
    <script type="text/javascript" src="__STATIC__/js/layer.js" ></script>
    <link rel="stylesheet" type="text/css" href="__STATIC__/css/layer.css"/>
    <script src="__PUBLIC__/js/global.js"></script>
    <script src="__PUBLIC__/js/mobile_common.js"></script>
    <script src="__STATIC__/js/common.js"></script>
    <script type="text/javascript">
        var process_request = "正在处理您的请求...";
        function share(){
            $('#share').show();
        }
    </script>
    <style >
        #share{
            z-index:9999999999999999999999;
            position:fixed;
            width:100%;
            height:100%;
            top:0px;
            right:0px;
            margin-top:0;
            background:url('__STATIC__/images/share.png') right top no-repeat #000;
            background-size:80%;
            opacity: 0.8;
        }
        .price_main img{
            padding-top: 0px;
            padding-bottom: 0px;
        }
    </style>
    <link href="__STATIC__/css/htmleaf-demo.css" rel="stylesheet" />

</head>
<body>
<div id="share" style="display:none" onclick="$(this).css('display','none');"></div>


<form name="buy_goods_form" method="post" id="buy_goods_form" >

    <img src="{$goods_images_list.0.image_url}" class="goods_info_banner" id="goods_info_banner" />


    <div class="price">
        <div class="price_left">{$goods.goods_name}</div>
    </div>
    <div class="price price2">
        <div class="price_left">
            ￥<span class="price_left_money">{$goods.shop_price}</span>
        </div>
        <div class="price_right">
            <div class="c_btn2"><a href="#picture" >立即购买</a></div>
        </div>
    </div>


    <div style="clear:both"></div>

    <div class="tabBox">
        <div class="bd" >
            <!--<div class="price_main" style="padding:20px">-->
                <!--<div class="tab_cp">-->
                    <!--<table width="100%" border="0" cellpadding="3" cellspacing="0">-->
                        <!--<tbody>-->
                        <!--<foreach name="goods['my_parameter']" item="item" key="key">-->
                            <!--<tr>-->
                                <!--<th colspan="2">{$key}</th>-->
                            <!--</tr>-->
                            <!--<tr></tr>-->
                            <!--<foreach name="item" ITEM="p_time" key="p_key" >-->
                                <!--<tr>-->
                                    <!--<td>{$p_key}</td>-->
                                    <!--<td>{$p_time}</td>-->
                                <!--</tr>-->
                            <!--</foreach>-->
                        <!--</foreach>-->

                        <!--</tbody>-->
                    <!--</table>-->
                <!--</div>-->
            <!--</div>-->

            <div class="con goods_content">
                {$goods.hide_goods_content|htmlspecialchars_decode}
                {$goods.goods_content|htmlspecialchars_decode}
            </div>
        </div>
    </div>
    <div id="picture" class="mui-popover mui-popover-action mui-popover-bottom">
        <div class="cp2">
            <div class="cp2_l">
                <img src="{$goods.goods_id|goods_thum_images=400,400}" width="92" height="92">
            </div>
            <div class="cp2_r">
                <p>{$goods.goods_name}</p>
                <span id="goods_price">￥{$goods.shop_price}</span>
                <div class="mui-numbox z-index" data-numbox-min="1" data-numbox-max="999999">
                    <button class="mui-btn mui-btn-numbox-minus" type="button" disabled=""  >-</button>
                    <input id="goods_num"  name="goods_num"   class="mui-input-numbox" type="text" value="1">
                    <input type="hidden" name="goods_id" value="{$goods.goods_id}"/>
                    <button class="mui-btn mui-btn-numbox-plus" type="button"  >+</button>
                </div>
            </div>
        </div>

        <div class="m33">
            <php> $number = 0 ;</php>
            <foreach item="spec" key="key" name="filter_spec">
                <div class="optionsDiv optionsDivNumber{$number}" data-spec = "{$number}" style=" <if condition='$number neq 0 '> display: none;</if> " >
                    <div class="cp2_titel">{$key}</div>
                    <ul>
                        <foreach name="spec" item="v2" key="k2">
                            <li onclick="switch_spec(this);">
                                <p>
                                    <a href="javascript:;"  title="{$v2[item]}" >{$v2[item]}</a>
                                </p>
                                <input type="radio" style="display:none;" name="goods_spec[{$key}]" value="{$v2[item_id]}" />
                            </li>
                        </foreach>
                    </ul>
                </div>
                <php> $number ++ ;</php>
            </foreach>

            <if condition =" $goods['is_on_sale'] == 1">
                <div class="m33_btn" id="next1"><a href="javascript:void(0);"  onclick="newSubmit();">加入购物车</a></div>
                <!--<div class="m33_btn" id="next2"><a href="javascript:void(0);" onClick="AjaxAddCart({$goods.goods_id},1,0);">加入购物车</a></div>-->
                <else/>
                <div class="m33_btn " >
                    <a style="background: #c2c2c2; border-color: #c0c0c0;" href="javascript:void(0);">商品已下架</a>
                </div>
            </if>
        </div>
    </div>

</form>
    <script type="text/javascript">

        var inCommentAjax = 0;
        var specNumber = -1;
        var show_is_buyer = 0;

        var one_spec = 0;

        $(function(){

            $("#goods_num").change(function(){
                get_goods_price();
            });
            get_goods_price();
            /*           <php>if($number==1){</php>*/
            one_spec = "{$spec_key}";
            var loadingClick = 0 ;
            $(".optionsDiv li").each(function(){
                if( loadingClick == 0){
                    var input_val = $(this).find("input").val();
                    if( input_val == "{$spec_key}"){
                        loadingClick = 1;
                        switch_spec($(this));
                    }
                }

            });
            longMiChange();
            $(".optionsDiv li").click(function(){
                var input_val = $(this).find("input").val();
                one_spec = input_val;
                longMiChange();
            });

            function longMiChange(){
                $(".my_goods_content").hide();
                $("#my_goods_content_"+one_spec).show();
                var src =  $("#goods_content_img_"+one_spec).data("src");
                if( src != undefined && src != ""){
                    $("#goods_info_banner").attr("src",src);
                }else{
                    $("#goods_info_banner").attr("src","{$goods_images_list.0.image_url}");
                }

            }

            /*           <php>}</php>*/
//            ajaxComment(1,1,0);// ajax 加载评价列表
        });






        function newSubmit(){
            var spec_goods_price = {$spec_goods_price};  // 规格 对应 价格 库存表   //alert(spec_goods_price['28_100']['price']);
            // 如果有属性选择项
            if(spec_goods_price != null)
            {
                var goods_spec_arr = new Array();
                $("input[name^='goods_spec']:checked").each(function(){
                    goods_spec_arr.push($(this).val());
                });
                var spec_key = goods_spec_arr.sort(sortNumber).join('_');  //排序后组合成 key
                if( spec_goods_price[spec_key] == null){
                    alert("请选择规格");
                    return;
                }
            }
            AjaxAddCart({$goods.goods_id},1,1);
        }
        function switch_spec(spec)
        {
            if( $(spec).hasClass("gray") ){
                return;
            }
            $(spec).siblings().removeClass('m33_hover');
            $(spec).addClass('m33_hover');
            $(spec).siblings().children('input').prop('checked',false);
            $(spec).find('input').prop('checked',true);
            var div = $(spec).parent().parent();
            specNumber = div.data("spec");
            $(".optionsDiv").each(function(){
                var specNumber2 = $(this).data("spec");
                if( specNumber2 < specNumber+1 ){
                    $(this).show();
                }else if(specNumber2 == specNumber+1){
                    $(this).show();
                    $(this).find("li").removeClass('m33_hover');
                    $(this).find("input[name^='goods_spec']:checked").attr("checked",false);
                }else{
                    $(this).hide();
                    $(this).find("li").removeClass('m33_hover');
                    $(this).find("input[name^='goods_spec']:checked").attr("checked",false);
                }
            });
            get_goods_price();
        }


        function get_goods_price()
        {
            var goods_price = {$goods.shop_price}; // 商品起始价
            var store_count = {$goods.store_count}; // 商品起始库存
            var spec_goods_price = {$spec_goods_price};  // 规格 对应 价格 库存表   //alert(spec_goods_price['28_100']['price']);
            // 如果有属性选择项
            if(spec_goods_price != null)
            {
                goods_spec_arr = new Array();
                $("input[name^='goods_spec']:checked").each(function(){
                    goods_spec_arr.push($(this).val());
                });
                var spec_key = goods_spec_arr.sort(sortNumber).join('_');  //排序后组合成 key
                if( spec_goods_price[spec_key] != null){
                    goods_price = spec_goods_price[spec_key]['price']; // 找到对应规格的价格
                    store_count = spec_goods_price[spec_key]['store_count']; // 找到对应规格的库存
                }else{
                    var tempSpecNumber = specNumber+1;
                    var temp_goods_spec_arr ;
                    $(".optionsDivNumber"+tempSpecNumber+" input").each(function(){
                        temp_goods_spec_arr = goods_spec_arr;
                        temp_goods_spec_arr.push($(this).val());
                        var temp_spec_key = temp_goods_spec_arr.sort(sortNumber).join('_');
                        removeFromArray(temp_goods_spec_arr,$(this).val());
                        if(spec_goods_price[temp_spec_key] != null && spec_goods_price[temp_spec_key]['store_count'] == 0){
                            $(this).parent().addClass("gray");
                            $(this).parent().attr("disabled",true);
                        }else{
                            $(this).parent().removeClass("gray");
                            $(this).parent().attr("disabled",false);
                        }
                    });
                    return;
                }
            }
            var goods_num = parseInt($("#goods_num").val());
            // 库存不足的情况
            if(goods_num > store_count)
            {
                goods_num = store_count;
                alert('库存仅剩 '+store_count+' 件');
                $("#goods_num").val(goods_num);
            }
            $("#goods_price").html('￥'+(goods_price*goods_num).toFixed(2)+''); // 变动价格显示

        }

        function sortNumber(a,b)
        {
            return a - b;
        }

        var removeFromArray = function (arr, val) {
            var index = $.inArray(val, arr);
            if (index >= 0)
                arr.splice(index, 1);
            return arr;
        };
//        var i = 1;
//        function ajaxComment(commentType,page,is_buyer){
//            inCommentAjax  = 1;
//            if(  page == 1 ){
//                var html = '<div class="mui-loading"><div class="mui-spinner"></div></div>';
//                $("#my_comment_list").html(html);
//            }
//
//            $("#getmore").remove();
//            $.ajax({
//                type : "GET",
//                url:"/index.php?m=Mobile&c=goods&a=ajaxComment&goods_id={$goods['goods_id']}&commentType="+commentType+"&p="+page+"&is_buyer="+is_buyer,//+tab,
//                success: function(data){
//                    if(  page == 1 ){
//                        $("#my_comment_list").html(data);
//                    }else{
//                        $("#my_comment_list").append(data);
//                    }
//                    inCommentAjax  = 0;
//                }
//            });
//        }


        //        setInterval("get_goods_price();console.log('123')",500);



    </script>
<include file="Public/nav"/>
</body>
<style>
    .nav_d {
        z-index: 0;
    }
    .m33 li {
        border: 1px solid #eaeaea;
    }
</style>
<include file="Public/footer"/>
</html>
